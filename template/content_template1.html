<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>
            {% block title %}
                个人主页
            {% endblock %}
    </title>
    <link rel="stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="stylesheet" type="text/css" href="/static/css/iview.css">
    <script type="text/javascript" src="/static/js/jquery-3.3.1.js"></script>
    <script type="text/javascript" src="/static/js/vue.js"></script>
    <script type="text/javascript" src="/static/js/iview.js"></script>
</head>
<body>
<div id="app1" >
    <row type="flex" style="background-color: #417690;">
        <i-col span="3" style="height: 50px;" >
            <img src="/static/img/red_circle.ico" class="titlealien" @click="to_index">
            <p class="ophiraFont" >OPHIRA</p>
        </i-col>
        <i-col span="7" style="height: 50px;"></i-col>
        <i-col span="14" style="height: 50px;">
            <div class="logout">
                欢迎, <span>${nickname}</span>， <Icon type="clock"></Icon> 当前时间 <span >${now}</span>
            </div>
            <div class="personal_center" >
                <dropdown style="margin-left: 20px">
                    <a><badge dot size="14" ><avatar src="/static/img/etlucency.png" size="large" /></badge></a>
                    <dropdown-menu slot="list" style="width: 30px">
                        <dropdown-item onclick="app_content_template1.to_index()">个人中心</dropdown-item>
                        <dropdown-item onclick="app_content_template1.open_userinfo_form() " >修改资料</dropdown-item>
                        <dropdown-item><p @click="change_password">修改密码</p></dropdown-item>
                        <dropdown-item>应用中心</dropdown-item>
                        <dropdown-item disabled>冰糖葫芦</dropdown-item>
                        <dropdown-item divided><a href="/logout" >退出登录</a></dropdown-item>
                    </dropdown-menu>
                </dropdown>
            </div>
        </i-col>
    </row>
    {#    菜单管理#}
    <row style="height: 760px">
        <i-col span="3" >
             <i-menu :theme="theme2" style="width: 170px;height: 0px">
                <submenu name="1">
                    <template slot="title">
                        <icon type="ios-paper"></icon>
                        个人中心
                    </template>
                    <menu-item name="1-1" onclick="app_content_template1.open_userinfo_form()"  >信息修改</menu-item>
                    <menu-item name="1-2" onclick="app_content_template1.change_password()">密码修改</menu-item>
                    <menu-item name="1-3">权限管理</menu-item>
                </submenu>
                <submenu name="2">
                    <template slot="title">
                        <icon type="ios-people"></icon>
                        应用中心
                    </template>
                    <menu-item name="2-1" onclick="app_content_template1.load_account()">应用账号</menu-item>
                    {% if  role  == 1  %}
                        <menu-item name="2-2" onclick="app_content_template1.open_vpn_window()">VPN协议切换</menu-item>
                        <menu-item name="2-3" onclick="app_content_template1.open_update_code()">更新线上代码</menu-item>
                    {% else %}
                        <menu-item name="2-2" title="普通账号不可使用该功能">VPN协议切换</menu-item>
                        <menu-item name="2-3" title="普通账号不可使用该功能">更新线上代码</menu-item>
                    {% endif %}

                </submenu>
                <submenu name="3">
                    <template slot="title">
                        <icon type="stats-bars"></icon>
                        系统管理
                    </template>
                    <menu-group title="使用">
                        <menu-item name="3-1">新增和启动</menu-item>
                        <menu-item name="3-2">活跃分析</menu-item>
                        <menu-item name="3-3">时段分析</menu-item>
                    </menu-group>
                    <menu-group title="留存">
                        <menu-item name="3-4">用户留存</menu-item>
                        <menu-item name="3-5">流失用户</menu-item>
                    </menu-group>
                </submenu>
            </i-menu>
        </i-col>
        <i-col span="18" push="1" style="height: 760px;">
            <div id="index_content" >
                <div class="middle_p">
                    <p style="color: #118b37"> Hello {{ nickname }} </p>
                    <p>本次登录IP： {{ ip }}</p>
                    <p >今天上海的天气状况是{{ weatherStatus }}，最高气温{{ weatherMax }}℃,最低气温{{ weatherMin }}℃。</p>
                </div>
            </div>
        </i-col>
    </row>
    <row type="flex" justify="end">
        <i-col span="18" pull="2" style="height: 139px;background-color: purple;">
    <div id="tail">
        {% block tail %}
            <a href="http://www.w3school.com.cn/index.html" target="_blank">w3school</a>
            <a href="https://github.com/alvinwancn" target="_blank">alvin的github</a>
            <a href="https://www.elastic.co/" target="_blank">ELK Stack</a>
            <a href="https://baidu.com" target="_blank">baidu.com</a>
            <a href="https://www.iviewui.com/docs/guide/install" target="_blank">iView</a>
        {% endblock %}
    </div>
        </i-col>
    </row>
    <Modal v-model="show_change_password" title="修改密码" width="40"  :closable='false' :mask-closable=false>
        <i-form ref="formPassword" :model="formPassword" :label-width="80" :rules="passwordRole" >
            <form-item label="当前密码 " prop="passwd">
                <i-input type="password" v-model="formPassword.oldpasswd"></i-input>
            </form-item>
            <form-item label="修改密码" prop="passwd">
                <i-input type="password" v-model="formPassword.passwd"></i-input>
            </form-item>
            <form-item label=确认密码 prop="passwdCheck">
                <i-input type="password" v-model="formPassword.passwdCheck"></i-input>
            </form-item>
        </i-form>
        <div slot="footer">
              <i-button type="text" @click="cancel_update_password">取消</i-button>
              <i-button type="primary" :loading="savePassLoading" @click="confirm_password(formPassword)">确认修改</i-button>
        </div>
    </Modal>


    <Modal v-model="show_userinfo_form" title="修改信息" width="40"  :closable='false' :mask-closable=false>
        <i-form ref="userinfo_form" :model="userinfo_form" :label-width="80" :rules="userinfo_rule" >
            <form-item label="Username " prop="username">
                <i-input type="text" v-model="userinfo_form.username" ></i-input>
            </form-item>
            <form-item label="Nickname " prop="nickname">
                <i-input type="text" v-model="userinfo_form.nickname"></i-input>
            </form-item>
            <form-item label=Email prop="email">
                <i-input type="email" v-model="userinfo_form.email"></i-input>
            </form-item>

        </i-form>
        <div slot="footer">
              <i-button type="text" @click="cancel_userinfo_form">取消</i-button>
              <i-button type="primary" :loading="savePassLoading" @click="confirm_userinfo_change_api(userinfo_form)" >确认修改</i-button>
        </div>
    </Modal>

    <Modal v-model="show_vpn" title="修改vpn类型" width="40"  :closable='false' :mask-closable=false>
    <radio-group v-model="vpn_type">
        <radio label="ipsec"></radio>
        <radio label="ikev2"></radio>
    </radio-group>
        <div slot="footer">
              <i-button type="text" @click="cancel_vpn_window">取消</i-button>
              <i-button type="primary" :loading="savePassLoading" @click="confirm_vpntype_api(vpn_type)" get_date>确认修改</i-button>
        </div>
    </Modal>

    <Modal v-model="show_update_code" title="更新线上代码" width="40"  :closable='false' :mask-closable=false>确定要更新代码吗？
        <div slot="footer">
              <i-button type="text" @click="cancel_update_code">取消</i-button>
              <i-button type="primary" :loading="savePassLoading" @click="update_code_api" >确认修改</i-button>
        </div>
    </Modal>
</div>
<script>

        function setCookie(name, value, iDay)
        {
            var oDate=new Date();
            oDate.setDate(oDate.getDate()+iDay);
            document.cookie=name+'='+encodeURIComponent(value)+';expires='+oDate;
        }
        function getCookie(name)
        {
            var arr=document.cookie.split('; ');
            var i=0;
            for(i=0;i<arr.length;i++)
            {
                //arr2->['username', 'abc']
                var arr2=arr[i].split('=');

                if(arr2[0]==name)
                {
                    var getC = decodeURIComponent(arr2[1]);
                    return getC;
                }
            }
            return '';
        }
        function removeCookie(name)
        {
            setCookie(name, '1', -1);
        }
    var app_content_template1=new Vue({
        el: '#app1',
        data: {
            visible: false,
            show_change_password:false,
            show_userinfo_form:false,
            savePassLoading:false,
            cpassword:'',
            mpassword:'',
            fpassword:'',
            show_vpn:false,
            now:'',
            nickname:getCookie('nickname'),
            vpn_type:'',
            userinfo_form:{
                username:'',
                nickname:'',
                email:'',
                birthday:'',

            },
           userinfo_rule:{
                username:[
                  { required: true, message: 'Please fill in the user name', trigger: 'blur' },
              ],
                nickname:[
                  { required: true, message: 'Please fill in the user name', trigger: 'blur' },
              ],
                email:[
                    { required: true, message: 'Please fill in the email address.', trigger: 'blur' },
                ],
            },
            formPassword: {
                oldpasswd: '',
                passwd: '',
                passwdCheck: '',
            },
           passwordRole:{
                oldpasswd:[
                     { required: true, message: 'Please fill in the old password.', trigger: 'blur' },
                     { type: 'string', min: 6, message: 'The password length cannot be less than 6 bits', trigger: 'blur' }
                ],
                passwd:[
                     { required: true, message: 'Please fill in the old password.', trigger: 'blur' },
                     { type: 'string', min: 6, message: 'The password length cannot be less than 6 bits', trigger: 'blur' }
                ],
                passwdCheck:[
                     { required: true, message: 'Please fill in the old password.', trigger: 'blur' },
                     { type: 'string', min: 6, message: 'The password length cannot be less than 6 bits', trigger: 'blur' }
                ]
            },
            show_update_code: false,

        },
        delimiters:['${', '}'],

        methods: {
            get_date:function (date) {
                this.userinfo_form.birthday=date
            },
            show: function () {
                this.visible = true;
            },
            change_password:function () {
                this.show_change_password = true
            },
            confirm_password:function (name) {
                var lastUp = this;
                $.ajax({
                    type: "POST",//方法类型
                    dataType: "json",//预期服务器返回的数据类型
                    url: "/change_password" ,//url
{#                    data: $('#form1').serialize(),#}
                    data:name,
                    success: function (result) {
                        console.log(result);//打印服务端返回的数据(调试用)
                        if (result.code == 0) {
                            lastUp.show_change_password=false
                            lastUp.$Message.success(result.message)
                        }else {
                            lastUp.$Message.warning(result.message)
                        };
                    },
                    error : function() {
{#                        alert("异常！");#}
                        lastUp.$Message.error('something is error')
                    }
                });
            },
            cancel_update_password:function () {
             this.show_change_password=false
            },
            open_userinfo_form:function () {
                $.ajax(
                    {
                        type: "POST",
                        dataType: "json",
                        url:"/user_info",
                        data:'',
                        success: function (result) {
                            if (result.code == 0) {
                                app_content_template1.userinfo_form=result
                            }else {
                                console.log(result)
                            }
                            ;
                        },
                        error : function(e) {
                            console.log(e)
                        },
                    })
                this.show_userinfo_form=true
                app_content_template1.userinfo_form.birthday=''
            },
            confirm_userinfo_change_api:function (name) {
                lastLayer=this
                $.ajax({
                    type: "POST",
                    dataType: "json",
                    url:"/api/confirm_userinfo_change_api",
                    data:name,
                    success: function (result) {
                        if (result.code == 0) {
                            lastLayer.$Message.success(result.message)
                            lastLayer.show_userinfo_form=false
                            setCookie('nickname',result.nickname)
                        }else {
                            lastLayer.$Message.warning(result.message)
                        }
                        ;
                    },
                    error : function(e,result) {
                        lastLayer.$Message.error(result.message)
                        console.log(e)
                    },
                })
            },
            cancel_userinfo_form:function () {
             this.show_userinfo_form=false
            },
            now_time:function () {
                 this.now = new Date().toTimeString();
            },
            to_index:function () {
                window.location.href="/";
            },
            load_account:function () {
                $('#index_content').load('/na',function (response,status,xhr) {

{#                    alert ('返回的值为:' +response + ',状态为：' + status + ',状态是：'+ xhr.statusText);#}
                })
            },
            open_vpn_window:function () {
                this.show_vpn=true
            },
            cancel_vpn_window:function () {
             this.show_vpn=false
            },
            confirm_vpntype_api:function (name) {
                console.log(app_content_template1.vpn_type)
                var lastLayer = this
                $.ajax({
                    type: "POST",
                    dataType: "json",
                    url:"/api/change_vpntype_api",
                    data:{'vpn_type':name},
                    success: function (result) {
                        if (result.code == 0) {
                            lastLayer.$Message.success(result.message)
                            console.log(result)
                            lastLayer.show_vpn=false

                        }else {
                            lastLayer.$Message.warning(result.message)
                        }
                        ;
                    },
                    error : function(e,result) {
                        lastLayer.$Message.error(result.message)
                        console.log(e)
                    },
                })
            },
            update_code_api:function (name) {
                var lastLayer = this
                $.ajax({
                    type: "GET",
                    dataType: "json",
                    url:"/api/update_code_api",
                    data:{},
                    success: function (result) {
                        if (result.code == 0) {
                            lastLayer.$Message.success(result.message)
                            lastLayer.show_update_code=false

                        }else {
                            lastLayer.$Message.warning(result.message)
                        }
                        ;
                    },
                    error : function(e,result) {
                        lastLayer.$Message.error(result.message)
                        console.log(e)
                    },
                })
            },
            open_update_code:function () {
                this.show_update_code=true
            },
            cancel_update_code:function () {
                this.show_update_code=false
            },

        }

    })
    setInterval('app_content_template1.now_time()',1000);

  </script>


</body>
</html>
